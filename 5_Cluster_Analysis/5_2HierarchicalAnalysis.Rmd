---
title: "aerfa3 = 0.7 Flow Condition"
author: "Nina Li"
date: "`r Sys.Date()`"
---

Hierarchical clustering
```{r}
library(cluster)
library(ggplot2)
library(factoextra)
library(reshape2)
library(corrplot)
```


From the first run, three metrics are correlated with each other
1. Strange_up ~ Qpeak
2. Strange_up ~ Strange_dw
3. Ramp_up ~ Ramp_dw
4. Qpeak ~ Strange_dw
5. RB_Index_dw ~ Strange_dw

Correlation Coefficient Analysis

```{r echo=FALSE}
# set working directory
HPK_Path <- "D:/Ninalty/UCD_Hydropeaking/HPK_FlowData/HPK_RDS/HPK_CA/HPK_wt/"

site_list <- list.files(path = HPK_Path, "_metric.csv") # remove sites not needed

site_list <- paste(HPK_Path, site_list, sep = "")

HPK_SM_metric <- list()

for (i in 1:length(site_list)) {
  
  tt <- read.csv(site_list[[i]])
  
  names(tt)[1] <- "location_id"
  
  tt$location_id <- as.character(tt$location_id)
  
  HPK_SM_metric[[i]] <- tt
}

# form the matrix
HPK_SM_metric <- bind_rows(HPK_SM_metric)

# get rownames as location id
rownames(HPK_SM_metric) <- HPK_SM_metric[,1]
HPK_SM_metric <- HPK_SM_metric[,-1]

# re-name all metrics
colnames(HPK_SM_metric) <- c("PKno","Qpeak","Qbase-flow","PKrtn","OffPKrtn","RC_fall","RC_rise","D_RC_fall","D_RC_rise","Strg_fall","Strg_rise","PKratio","Tmax","RB_Index_fall","RB_Index_rise")

#select the needed metrics
HPK_SM_metric <- HPK_SM_metric[,!names(HPK_SM_metric) %in% c("Qbase-flow", "OffPKrtn","Strg_rise","RC_rise","D_RC_rise","RB_Index_fall","RB_Index_rise", "Qpeak")]

# change the colnames to fit with the article
colnames(HPK_SM_metric) <- c("PKno", "PKrtn", "RC_fall", "D_RC_fall", "Strg_fall", "PKratio", "Tmax")


corrplot(cor(HPK_SM_metric), type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

```

The table look

```{r echo=FALSE}
cor(HPK_SM_metric)
```

replace site name
```{r}
# # Replace the name of clusters
# site_id <- rownames(HPK_SM_metric)
# 
# site_id[11:19] <- c("11238100","11238380","11238400","11241800","11246530","11238550","11235100","01123550","11238250")
# 
# rownames(HPK_SM_metric) <- site_id
```


2 Normalization + Distance matrix
```{r echo=FALSE}
HPK_SM_metric2 <- apply(HPK_SM_metric, 2, function(df){(df-min(df))/(max(df)-min(df))}) #check here

d <- dist(HPK_SM_metric2, method = "euclidean")
```


Iterative way to decide cluster number
```{r echo=FALSE}
library(NbClust)
```

This validation method gave me four
hartigan
ratkowsky
trcovw
tracew
rubin
KL


```{r echo=FALSE}
NbClust(HPK_SM_metric2, distance = "euclidean", min.nc = 2, max.nc = 8, method = "ward.D2", index = "hartigan")
```

Wards

```{r echo=FALSE}
#WHD Clustering analysis
hc2 <- hclust(d, method = "ward.D2" )

#cut trees
sub_grp <- cutree(hc2, k =4)

# Replace the name of clusters
sub_grp[c(1:33)] <- gsub(1, "G1", sub_grp[c(1:33)])

sub_grp[c(1:33)] <- gsub(2, "G2", sub_grp[c(1:33)])

sub_grp[c(1:33)] <- gsub(3, "G3", sub_grp[c(1:33)])

sub_grp[c(1:33)] <- gsub(4, "G4", sub_grp[c(1:33)])
```


Dendrogram
```{r echo=FALSE}
# Plot the obtained dendrogram
plot(hc2, cex = 0.6, hang = -1)
rect.hclust(hc2, k = 4, border = 2:5)

# jpeg(filename = "HWD_Dendrogram.jpg", quality = 75, width = 480, height = 480, units = "px")
```

Plot dendrogram with ggplot
```{r include=FALSE}
library(ggdendro)

#convert cluster object to use with ggplot
dendr <- dendro_data(hc2, type="rectangle") 

#your own labels are supplied in geom_text() and label=label
dendr_plot <- ggplot() + geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
                 geom_text(data=label(dendr), aes(x=x, y=y, label=label, hjust=0), size=3) +
                 coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
                 labs(y = "Distance") +
                 theme(axis.line.x=element_line(color = "black", size = 0.7),
                      axis.ticks.y=element_blank(),
                      axis.text.y=element_blank(),
                      axis.text.x = element_text(size = 11),
                      axis.title.y=element_blank(), 
                      axis.title.x=element_text(size = 15),
                      panel.background=element_rect(fill="white"),
                      panel.grid=element_blank()) 

# ggsave(paste("WHD_Dendro_plot.png"), plot = dendr_plot, path = "D:/Ninalty/UCD_Hydropeaking/HPK_Imagery/", width = 30, height = 20, units = "cm")

dendr_plot  
```


boxplot
```{r echo=FALSE}
classed_hpk_wd <- cbind(HPK_SM_metric, sub_grp)
classed_hpk_wd$location_id <- row.names(classed_hpk_wd)

variable_list <- colnames(classed_hpk_wd)[1:7]

remove(classed_hpk2_wd)
classed_hpk2_wd <- melt(classed_hpk_wd,id.vars = c("location_id","sub_grp"), measure.vars = variable_list)

variable_boxpt <- ggplot(classed_hpk2_wd, aes(x=as.factor(sub_grp), y=value))+ geom_boxplot()+facet_wrap(~variable, nrow = 2,  scales = "free_y")+xlab("")+theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(colour = "black", fill=NA), axis.text.x = element_text(size=12), axis.title.y = element_text(size = 12))

variable_boxpt
```

Normalized version of the above boxplot

```{r include=FALSE}
classed_hpk3_wd <- apply(classed_hpk_wd[,-c(8:9)], 2, function(df){(df-min(df))/(max(df)-min(df))})

classed_hpk3_wd <- cbind(classed_hpk3_wd, classed_hpk_wd[,c(8:9)])

remove(classed_hpk2_wd)
classed_hpk2_wd <- melt(classed_hpk3_wd,id.vars = c("location_id","sub_grp"), measure.vars = variable_list)

variable_boxpt2 <- ggplot(classed_hpk2_wd, aes(x=as.factor(sub_grp), y=value))+ geom_boxplot()+facet_wrap(~variable, nrow = 2,  scales = "free_y")+xlab("")+theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(colour = "black", fill=NA), axis.text.x = element_text(size=12), axis.title.y = element_text(size = 12))

variable_boxpt2
# ggsave("D:/Ninalty/Hydropeaking/RWork/Plols/WHD_VariableNz_boxpt2.jpg", plot = variable_boxpt2, width = 20, height = 10, units = "cm")
```
































